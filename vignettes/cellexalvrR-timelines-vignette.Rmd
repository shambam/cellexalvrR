---
title: "Timelines in VR and beyond"
author: "Stefan Lang"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette
  
vignette: >
  %\VignetteIndexEntry{cellexalvrR timelines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Timelines

Timelines in CellexalVR are simple one group selections. 
But remember that the algorithm will only work if the selection has a linear shape.

Interally CellexalvrR clusters the drc data from the selection using kmeans.
These kmean clusters are subsequently provided to Slingshot which in turn calculates the
pseudotime. CellexalvrR checks the correlation between pseudotime and the order in the selection file,
flipping the pseudotime if necesary.
Gene expression is afterwards correlated to the calculated pseudotime and 125 top and 125 bottom top 
genes are retrurned to the VR process and displayed as VR heatmap.

## And Beyond

The timeline analysis turned out to be more valuable than that.
In many projects it is of major interest to highlight sample differences in relation to a timeline.

To help in this analysis CellexlvrR provides the cellexalTime class. Every time the user creates a single selection heatmap in VR a time object is created. This time object can be accessed from the cellexalObj.RData file in the project output folder.

For this vignett I will use the inbuilt dataset and a saved one group selection.

```{r,message=FALSE}
library(cellexalvrR)

cellexalObj = reset( cellexalObj )
cellexalObj

```

And the provided one group selection:

```{r,message=FALSE}
head( read.delim( system.file("extdata", "SelectionHSPC_time.txt", package="cellexalvrR"), header=F ) )

```

All timeline function are based on the cellexalvrR logging system and therefore we need to start a log before we can use them:

```{r,message=FALSE}

cellexalObj@outpath = getwd()
cellexalObj = sessionPath( cellexalObj, 'timelineExample')


```

Next we will calculate the timeline and create the linear correlation.
This part of the analysis would have been run during your VR session.

```{r,message=FALSE}
cellexalObj = userGrouping( cellexalObj, system.file("extdata", "SelectionHSPC_time.txt",package= "cellexalvrR") )
cellexalObj = pseudotimeTest3D(cellexalObj, grouping= cellexalObj@usedObj$lastGroup )
cellexalObj = createStats( "lastEntry" , cellexalObj,  num.sig= 250 )

bossTime = cellexalObj@usedObj$timelines[["lastEntry"]]
cellexalObj = createReport(bossTime, cellexalObj, info = bossTime)$cellexalObj


# the statistics table
print ( head( cellexalObj@usedObj$sigGeneLists$lin[[ cellexalObj@usedObj$lastGroup ]] ))

length( cellexalObj@usedObj$deg.genes)
```

You can get information about the existsing timelines in a cellexalvrR object by printing the timelines list.

```{r, message=FALSE}
cellexalObj@usedObj$timelines
```

You see ther 'lastEntry' timeline will aloways be in the first place in this list
and the 'lastEntry' timline is always a copy of a timeline in the list.

### compareGeneClusters

CompareGeneClusters is a function to compare gene expression profiles between two timelines.
It requires to have clutered the same genes in two different timelines.

How to do this?

For a real live example the cells in the timeline could be separated by treatment, age, desease state or any other research interest.
For this example I can only create an even split between the samples:

```{r, message=FALSE}
time = getTime(cellexalObj, bossTime)

subset1 = rownames(time@dat)[seq(1,nrow(time@dat),2)]
subset2 = rownames(time@dat)[seq(2,nrow(time@dat),2)]

timeSubset1 = subsetTime( time, subset1)
timeSubset2 = subsetTime( time, subset2)

cellexalObj = addSelection( timeSubset1, cellexalObj )
timeSubset1 = cellexalObj@usedObj$timelines[[1]]

cellexalObj = addSelection( timeSubset2, cellexalObj )
timeSubset2 = cellexalObj@usedObj$timelines[[1]]

cellexalObj = createStats( timeSubset1, cellexalObj,  num.sig= 250 )
deg.genes = cellexalObj@usedObj$deg.genes

cellexalObj = createReport( timeSubset1, cellexalObj, 
     timeSubset1, deg.genes = deg.genes )$cellexalObj

cellexalObj = createStats( timeSubset2, cellexalObj,  num.sig= 250 )
cellexalObj = createReport(timeSubset2, cellexalObj, 
     timeSubset2, deg.genes = deg.genes )$cellexalObj

cellexalObj = compareGeneClusters ( 
   getTime(cellexalObj,timeSubset1@gname), 
   getTime(cellexalObj,timeSubset2@gname), 
	 cellexalObj, altGroupNames=c("subset A", "subset B" ) 
)

```

In the end the report has to be finalized:

```{r, message=FALSE}
cellexalObj = renderReport( cellexalObj)
```

```{r, echo=FALSE}
## copy the main outfile to the doc folder
if ( file.exists( 'PortableLog_timelineExample.zip' )){
	file.copy( 'PortableLog_timelineExample.zip', "../doc/" )
}

```

## The portable log file

As with the CellexalVR session log system this R session will create ['a zipped portable log file'](./PortableLog_timelineExample.zip)
that can be copied to any computer unzipped and viewed using any web browser.





